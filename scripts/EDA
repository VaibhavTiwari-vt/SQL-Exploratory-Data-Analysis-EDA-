/*
Purpose : Explore the database,dimensions,measures etc to find the answers for business question.
*/
-- DATABASE EXPLORATION

-- Explore All Objects in the Database
Select * from INFORMATION_SCHEMA.TABLES;

-- Explore All Columns in the Database
Select * from INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME='dim_customers';

-- DIMENSIONS EXPLORATION


--Explore All Countries our customers come from.
SELECT DISTINCT country FROM gold.dim_customers

-- All Categories "The major divisions"
SELECT DISTINCT category,subcategory, product_name FROM gold.dim_products ORDER BY 1,2,3

-- DATE EXPLORATION

--Find the date of the first and last order
-- How many years of sales are available?
SELECT min(order_date) first_order_date , max(order_date) last_order_date , datediff(year,min(order_date),max(order_date)) as year_range
from gold.fact_sales

--Find the youngest and the oldest customers
select CONCAT(first_name,' ',last_name) as name from gold.dim_customers where birthdate in
(SELECT min(birthdate) as oldest_birthdate  from gold.dim_customers union
SELECT max(birthdate) as youngest_birthdate from gold.dim_customers);

select datediff(year,min(birthdate),getdate()) as oldest_age , datediff(year,max(birthdate),getdate()) as youngest_age
from gold.dim_customers

--################# MEASURES EXPLORATION ##############################

--Find the Total Sales
--Find how many items are sold
--Find the average selling price
--Find the Total Number of Orders
select sum(sales_amount) as total_sales , sum(quantity) as total_items_sold,
avg(price) as avg_price, count(order_number) as total_orders
, count(distinct order_number) as total_distinct_orders from gold.fact_sales

--Find the Total Number of Products
select count(product_key) as total_products from gold.dim_products

--Find the Total Number of Customers
select count(customer_key) as total_customers from gold.dim_customers

--Find the Total Number of Customers that has placed an order
select count(distinct customer_key) as total_customers_placed_order from gold.fact_sales

-- Generate a Report that shows all key metrics of the business

SELECT 'Total Sales' as measure_name,SUM(sales_amount) as Measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Quantity' as measure_name,SUM(quantity) as Measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Average Price' as measure_name,AVG(price) as Measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Orders' as measure_name,Count(distinct order_number) as Measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Products' as measure_name,count(product_name) as Measure_value FROM gold.dim_products
UNION ALL
SELECT 'Total Customers' as measure_name,count(customer_key) as Measure_value FROM gold.dim_customers;


--################# MAGNITUDE ##############################

--Find total customers by countries
SELECT country,count(customer_key) as total_customers from gold.dim_customers group by country order by total_customers desc;
--Find total customers by gender
SELECT gender,count(customer_key) as total_customers from gold.dim_customers group by gender order by total_customers desc;
--Find total products by category
SELECT category,count(product_key) as total_products from gold.dim_products group by category order by total_products desc;
--What is the average costs in each category?
select category,avg(cost) as average_cost from gold.dim_products group by category order by average_cost desc;
--What is the total revenue generated for each category?
select p.category,sum(f.sales_amount) as total_revenue from gold.fact_sales f left join 
gold.dim_products p on p.product_key=f.product_key group by p.category order by total_revenue desc;
--Find total revenue is generated by each customer
select c.customer_key,c.first_name,c.last_name,sum(f.sales_amount) as amount_spent from gold.fact_sales f left join
gold.dim_customers c on c.customer_key=f.customer_key group by c.customer_key,c.first_name,c.last_name order by amount_spent desc;
--What is the distribution of sold items across countries?
select c.country,sum(f.quantity) as total_sold from gold.fact_sales f left join
gold.dim_customers c on c.customer_key=f.customer_key group by c.country order by total_sold desc;

--################# Ranking Top N - Bottom N ##############################

--Which 5 products generate the highest revenue?
select TOP 5 p.product_name,sum(f.sales_amount) as total_revenue from gold.fact_sales f left join 
gold.dim_products p on p.product_key=f.product_key group by p.product_name order by total_revenue desc ;

select * from (select p.product_name,sum(f.sales_amount) as total_revenue,ROW_NUMBER()  OVER(ORDER BY sum(f.sales_amount) desc) as rank_products from gold.fact_sales f left join 
gold.dim_products p on p.product_key=f.product_key group by p.product_name)t where rank_products<=5 ;

--What are the 5 worst-performing products in terms of sales?
select TOP 5 p.product_name,sum(f.sales_amount) as total_revenue from gold.fact_sales f left join 
gold.dim_products p on p.product_key=f.product_key group by p.product_name order by total_revenue ;
